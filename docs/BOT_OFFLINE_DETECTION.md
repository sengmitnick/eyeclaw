# Bot ç¦»çº¿æ£€æµ‹æœºåˆ¶

## æ¦‚è¿°

å½“ Rokid çœ¼é•œå‘é€è¯·æ±‚æ—¶ï¼Œç³»ç»Ÿä¼šç«‹å³æ£€æµ‹ Bot æ˜¯å¦åœ¨çº¿ï¼Œå¦‚æœç¦»çº¿åˆ™å¿«é€Ÿè¿”å›é”™è¯¯æ¶ˆæ¯ï¼Œé¿å…é•¿æ—¶é—´ç­‰å¾…è¶…æ—¶ã€‚

## ç¦»çº¿æ£€æµ‹æ—¶æœº

### 1. ç«‹å³æ£€æµ‹ï¼ˆè¯·æ±‚å¼€å§‹æ—¶ï¼‰

åœ¨æ¥æ”¶åˆ° SSE è¯·æ±‚åï¼Œç³»ç»Ÿä¼šç«‹å³é€šè¿‡ `BotSession` æ¨¡å‹æ£€æµ‹ Bot çš„åœ¨çº¿çŠ¶æ€ï¼š

```ruby
# æ£€æŸ¥ Bot æ˜¯å¦åœ¨çº¿ï¼ˆé€šè¿‡ BotSession çš„ last_ping_atï¼‰
bot_session = BotSession.where(bot_id: bot.id)
                       .where('last_ping_at > ?', 5.minutes.ago)
                       .order(last_ping_at: :desc)
                       .first

unless bot_session
  Rails.logger.warn "[RokidSSE] Bot #{bot.id} is offline (no active session)"
  # ç«‹å³è¿”å›ç¦»çº¿é”™è¯¯
  error_message = "Bot å·²ç¦»çº¿ï¼Œè¯·æ£€æŸ¥è®¾å¤‡è¿æ¥åé‡è¯•ã€‚"
  # ...å‘é€ SSE é”™è¯¯äº‹ä»¶
  return
end
```

**åˆ¤æ–­æ ‡å‡†ï¼š** Bot è¢«è®¤ä¸ºåœ¨çº¿éœ€è¦æ»¡è¶³ï¼š
- å­˜åœ¨ BotSession è®°å½•
- `last_ping_at` åœ¨ 5 åˆ†é’Ÿå†…ï¼ˆ`last_ping_at > 5.minutes.ago`ï¼‰

**ç”¨æˆ·ä½“éªŒï¼š**
- å“åº”æ—¶é—´ï¼š< 0.1 ç§’
- é”™è¯¯æ¶ˆæ¯ï¼š`"Bot å·²ç¦»çº¿ï¼Œè¯·æ£€æŸ¥è®¾å¤‡è¿æ¥åé‡è¯•ã€‚"`

### 2. è¶…æ—¶æ£€æµ‹ï¼ˆç­‰å¾…å“åº”æ—¶ï¼‰

å¦‚æœ Bot åœ¨è¯·æ±‚å¼€å§‹æ—¶åœ¨çº¿ï¼Œä½†åœ¨ç­‰å¾…å“åº”è¿‡ç¨‹ä¸­ç¦»çº¿æˆ–æ— å“åº”ï¼Œç³»ç»Ÿä¼šåœ¨ 60 ç§’åè¶…æ—¶ï¼š

```ruby
# 60 ç§’ç©ºé—²è¶…æ—¶
idle_timeout = 60

# æ£€æŸ¥æ˜¯å¦è¶…æ—¶
if Time.current - last_message_time > idle_timeout
  Rails.logger.warn "[RokidSSE] Idle timeout: no response from Bot after #{idle_timeout} seconds"
  
  # å‘é€è¶…æ—¶é”™è¯¯æ¶ˆæ¯
  error_message = "è¯·æ±‚è¶…æ—¶ï¼ŒBot å¯èƒ½å·²ç¦»çº¿æˆ–å“åº”ç¼“æ…¢ï¼Œè¯·ç¨åé‡è¯•ã€‚"
  # ...å‘é€ SSE é”™è¯¯äº‹ä»¶
  break
end
```

**è§¦å‘æ¡ä»¶ï¼š**
- Bot è®¢é˜…äº† ActionCable é¢‘é“ä½† 60 ç§’å†…æ²¡æœ‰å‘é€ä»»ä½•æ¶ˆæ¯
- å¯èƒ½åŸå› ï¼šBot è¿›ç¨‹å´©æºƒã€ç½‘ç»œæ–­å¼€ã€å¤„ç†è¶…æ—¶

**ç”¨æˆ·ä½“éªŒï¼š**
- å“åº”æ—¶é—´ï¼š60 ç§’
- é”™è¯¯æ¶ˆæ¯ï¼š`"è¯·æ±‚è¶…æ—¶ï¼ŒBot å¯èƒ½å·²ç¦»çº¿æˆ–å“åº”ç¼“æ…¢ï¼Œè¯·ç¨åé‡è¯•ã€‚"`

## å®ç°ä½ç½®

### rokid_sse_controller.rb

ç¦»çº¿æ£€æµ‹é€»è¾‘åœ¨ä¸¤ä¸ª SSE å®ç°ä¸­éƒ½æœ‰ï¼š

#### 1. sse_hijack æ–¹æ³•ï¼ˆRack åŠ«æŒæ¨¡å¼ï¼‰

**ç«‹å³æ£€æµ‹ï¼š** ç¬¬ 117-144 è¡Œ
```ruby
# åœ¨æ‰¾åˆ° Bot åç«‹å³æ£€æŸ¥åœ¨çº¿çŠ¶æ€
bot_session = BotSession.where(bot_id: bot.id)...
unless bot_session
  # å‘é€ç¦»çº¿é”™è¯¯å¹¶å…³é—­è¿æ¥
  ...
end
```

**è¶…æ—¶æ£€æµ‹ï¼š** ç¬¬ 200-223 è¡Œ
```ruby
# åœ¨æ¶ˆæ¯å¾ªç¯ä¸­æ£€æµ‹ç©ºé—²è¶…æ—¶
if Time.current - last_message_time > idle_timeout
  # å‘é€è¶…æ—¶é”™è¯¯å¹¶é€€å‡ºå¾ªç¯
  ...
end
```

#### 2. sse_live æ–¹æ³•ï¼ˆActionController::Live æ¨¡å¼ï¼‰

**ç«‹å³æ£€æµ‹ï¼š** ç¬¬ 421-433 è¡Œï¼ˆé€»è¾‘ä¸ hijack æ¨¡å¼ç›¸åŒï¼‰

**è¶…æ—¶æ£€æµ‹ï¼š** ç¬¬ 527-535 è¡Œï¼ˆé€»è¾‘ä¸ hijack æ¨¡å¼ç›¸åŒï¼‰

## BotSession æ¨¡å‹

### å­—æ®µ

- `bot_id`: å…³è”çš„ Bot ID
- `session_id`: å”¯ä¸€ä¼šè¯æ ‡è¯†
- `connected_at`: è¿æ¥å»ºç«‹æ—¶é—´
- `last_ping_at`: æœ€åå¿ƒè·³æ—¶é—´ï¼ˆç”¨äºåˆ¤æ–­åœ¨çº¿çŠ¶æ€ï¼‰
- `metadata`: é¢å¤–å…ƒæ•°æ®ï¼ˆJSONBï¼‰

### åœ¨çº¿åˆ¤æ–­é€»è¾‘

Bot è¢«è®¤ä¸ºåœ¨çº¿çš„æ¡ä»¶ï¼š
```ruby
# Scope
scope :active, -> { where('last_ping_at > ?', 5.minutes.ago) }

# Instance method
def active?
  last_ping_at && last_ping_at > 5.minutes.ago
end
```

### å¿ƒè·³ç»´æŠ¤

Bot å®¢æˆ·ç«¯éœ€è¦å®šæœŸæ›´æ–° `last_ping_at` ä»¥ç»´æŒåœ¨çº¿çŠ¶æ€ï¼š
- å»ºè®®é¢‘ç‡ï¼šæ¯ 1-2 åˆ†é’Ÿ
- è¶…æ—¶é˜ˆå€¼ï¼š5 åˆ†é’Ÿ
- æ›´æ–°æ–¹å¼ï¼š`bot_session.touch(:last_ping_at)`

## é”™è¯¯æ¶ˆæ¯æ ¼å¼

æ‰€æœ‰ç¦»çº¿æ£€æµ‹é”™è¯¯éƒ½éµå¾ªç»Ÿä¸€çš„ SSE æ¶ˆæ¯æ ¼å¼ï¼š

### Message äº‹ä»¶ï¼ˆåŒ…å«é”™è¯¯å†…å®¹ï¼‰
```json
{
  "role": "agent",
  "type": "answer",
  "answer_stream": "é”™è¯¯æ¶ˆæ¯æ–‡æœ¬",
  "message_id": "...",
  "agent_id": "...",
  "is_finish": true
}
```

### Done äº‹ä»¶ï¼ˆç»ˆæ­¢æ ‡è®°ï¼‰
```json
{
  "role": "agent",
  "type": "answer",
  "message_id": "...",
  "agent_id": "...",
  "is_finish": true
}
```

**æ³¨æ„ï¼š** `done` äº‹ä»¶ä¸åŒ…å« `answer_stream` å­—æ®µï¼Œé¿å…é‡å¤æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯ã€‚

## æµ‹è¯•

### æµ‹è¯•è„šæœ¬

`tmp/test_offline_simple.rb` æä¾›äº†ç¦»çº¿æ£€æµ‹åŠŸèƒ½çš„è‡ªåŠ¨åŒ–æµ‹è¯•ï¼š

```bash
rails runner tmp/test_offline_simple.rb
```

### æµ‹è¯•åœºæ™¯

**åœºæ™¯ 1ï¼šBot å®Œå…¨ç¦»çº¿**
- åˆ é™¤æ‰€æœ‰ BotSession è®°å½•
- å‘é€ SSE è¯·æ±‚
- é¢„æœŸï¼š< 0.1 ç§’å†…æ”¶åˆ°ç¦»çº¿é”™è¯¯æ¶ˆæ¯

**åœºæ™¯ 2ï¼šBot åœ¨çº¿ä½†æ— å“åº”**
- åˆ›å»ºæ´»è·ƒçš„ BotSession
- å‘é€ SSE è¯·æ±‚ä½† Bot ä¸å“åº”
- é¢„æœŸï¼š60 ç§’åæ”¶åˆ°è¶…æ—¶é”™è¯¯æ¶ˆæ¯ï¼ˆæµ‹è¯•ä¸­è·³è¿‡ä»¥èŠ‚çœæ—¶é—´ï¼‰

### æµ‹è¯•ç»“æœç¤ºä¾‹

```
============================================================
æµ‹è¯• 1: Bot ç¦»çº¿ï¼ˆæ—  active sessionï¼‰
============================================================
ğŸ“‹ Active sessions: 0

ğŸ“¤ å‘é€è¯·æ±‚åˆ°ç¦»çº¿çš„ Bot...
â±ï¸  å“åº”æ—¶é—´: 0.06 ç§’

ğŸ“¥ å“åº”å†…å®¹:
: connected

event: message
data: {"role":"agent","type":"answer","answer_stream":"Bot å·²ç¦»çº¿ï¼Œè¯·æ£€æŸ¥è®¾å¤‡è¿æ¥åé‡è¯•ã€‚","message_id":"...","agent_id":"...","is_finish":true}

event: done
data: {"role":"agent","type":"answer","message_id":"...","agent_id":"...","is_finish":true}

âœ… æµ‹è¯•é€šè¿‡ï¼šæ”¶åˆ°ç¦»çº¿é”™è¯¯æ¶ˆæ¯
âœ… æµ‹è¯•é€šè¿‡ï¼šå¿«é€Ÿå“åº”ï¼ˆ< 5ç§’ï¼‰
```

## æ€§èƒ½ç‰¹æ€§

- **ç«‹å³æ£€æµ‹ï¼š** å•æ¬¡æ•°æ®åº“æŸ¥è¯¢ï¼ˆindexedï¼‰ï¼Œ< 10ms
- **æ— é¢å¤–è½®è¯¢ï¼š** åˆ©ç”¨ç°æœ‰ BotSession å¿ƒè·³æœºåˆ¶
- **å¿«é€Ÿå¤±è´¥ï¼š** ç¦»çº¿æ—¶ç«‹å³è¿”å›ï¼Œæ— éœ€ç­‰å¾…
- **ç”¨æˆ·å‹å¥½ï¼š** æ˜ç¡®çš„é”™è¯¯æç¤ºï¼Œä¸ä¼šé•¿æ—¶é—´ç­‰å¾…æ— å“åº”

## ç›¸å…³æ–‡æ¡£

- [å®‰å…¨ç»‘å®šæµç¨‹](./SECURE_BINDING_FLOW.md)
- [é‡å¤é”™è¯¯æ¶ˆæ¯ä¿®å¤](./BUGFIX_DUPLICATE_ERROR_MESSAGE.md)
